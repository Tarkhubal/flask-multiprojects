{% extends "base.html" %}

{% block body_class %}spa-enabled{% endblock %}
{% block spa_index %}data-spa{% endblock %}
{% block spa_flask %}data-spa{% endblock %}
{% block spa_md %}data-spa{% endblock %}

{% block title %}{{ current_page }} - {{ project_name }}{% endblock %}

{% block content %}
<div class="container-wide">
    <div class="breadcrumb fade-in">
        <a href="{{ url_for('index') }}" data-spa>Accueil</a> / 
        <a href="{{ url_for('notion_list') }}" data-spa>Projets Notion</a> / 
        <a href="{{ url_for('notion_project', project_name=project_name) }}" data-spa>{{ project_emoji }} {{ project_display_name }}</a>
    {% set without_ext = current_page.rsplit('.', 1)[0] %}
    {% set path_parts = without_ext.split('/') %}
        {% for i in range(path_parts|length) %}
            {% set segment = path_parts[i] %}
            {% set path_so_far = '/'.join(path_parts[:i+1]) %}
            {% if i < path_parts|length - 1 %}
                / <a href="{{ url_for('notion_page', project_name=project_name, page=path_so_far) }}" data-spa>{{ segment }}</a>
            {% else %}
                / <span>{{ segment }}</span>
            {% endif %}
        {% endfor %}
    </div>

    <div class="md-layout">
        <aside class="md-sidebar slide-left">
            <div class="sidebar-header">
                <h3>{{ project_emoji }} {{ project_display_name }}</h3>
                {% if config.description %}
                    <p class="project-description">{{ config.description }}</p>
                {% endif %}
            </div>
            
            <div class="sidebar-controls">
                <h4>üìë Fichiers</h4>
                <div class="folder-controls">
                    <button class="folder-control-btn" id="expand-all" title="D√©plier tout">
                        <i class="fa-solid fa-angles-down"></i>
                    </button>
                    <button class="folder-control-btn" id="collapse-all" title="Replier tout">
                        <i class="fa-solid fa-angles-up"></i>
                    </button>
                </div>
            </div>
            
            <div class="search-container">
                <input type="text" id="file-search" class="file-search-input" placeholder="üîç Rechercher un fichier...">
            </div>
            
            <div class="file-tree">
                {% macro render_tree(tree, path='') %}
                    {% if tree.files %}
                        <ul class="file-list">
                            {% for file in tree.files %}
                                <li class="file-item {% if file.path == current_page %}active{% endif %}">
                                    <a href="{{ url_for('notion_page', project_name=project_name, page=file.slug) }}" class="file-link" data-spa>
                                        <span class="file-icon">
                                            {% if file.path == current_page %}‚ñ∂
                                            {% elif file.type == 'database' %}üìä
                                            {% else %}üìù{% endif %}
                                        </span>
                                        <span class="file-name">{{ file.name }}</span>
                                    </a>
                                </li>
                            {% endfor %}
                        </ul>
                    {% endif %}
                    {% if tree.folders %}
                        {% for folder_name, subtree in tree.folders.items() %}
                            <details class="folder" {% if path in current_page or not path %}open{% endif %}>
                                <summary class="folder-summary">
                                    <span class="folder-icon">{% if path in current_page or not path %}üìÇ{% else %}üìÅ{% endif %}</span>
                                    <span class="folder-name">{{ folder_name }}</span>
                                </summary>
                                <div class="folder-content">
                                    {{ render_tree(subtree, path + folder_name + '/') }}
                                </div>
                            </details>
                        {% endfor %}
                    {% endif %}
                {% endmacro %}
                
                {{ render_tree(file_tree) }}
            </div>
            
            <div class="keyboard-shortcuts">
                <h5>‚å®Ô∏è Raccourcis</h5>
                <ul>
                    <li><kbd>‚Üë</kbd> <kbd>‚Üì</kbd> Naviguer entre fichiers</li>
                </ul>
            </div>
        </aside>

        <article class="md-content">
            <h1>üìä {{ csv_data.filename }}</h1>
            
            {% if csv_data.headers and csv_data.rows %}
                <div class="notion-database-container">
                    <div class="table-info">
                        <p>{{ csv_data.rows|length }} entr√©e{% if csv_data.rows|length > 1 %}s{% endif %} ‚Ä¢ {{ csv_data.headers|length }} colonne{% if csv_data.headers|length > 1 %}s{% endif %}</p>
                    </div>
                    <div class="table-wrapper">
                        <table class="notion-database">
                            <thead>
                                <tr>
                                    {% for header in csv_data.headers %}
                                        <th>{{ header }}</th>
                                    {% endfor %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for row in csv_data.rows %}
                                    <tr>
                                        {% for cell in row %}
                                            <td>{{ cell }}</td>
                                        {% endfor %}
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            {% else %}
                <div class="empty-state">
                    <p class="empty-message">Cette base de donn√©es est vide</p>
                </div>
            {% endif %}
        </article>
    </div>
</div>

<style>
.notion-database-container {
    margin-top: 2rem;
}

.table-info {
    margin-bottom: 1rem;
    color: var(--text-secondary);
    font-size: 0.9rem;
}

.table-wrapper {
    overflow-x: auto;
    border-radius: 8px;
    border: 1px solid var(--border);
}

.notion-database {
    width: 100%;
    border-collapse: collapse;
    background: var(--bg);
}

.notion-database thead {
    background: var(--bg-secondary);
    position: sticky;
    top: 0;
    z-index: 10;
}

.notion-database th {
    padding: 12px 16px;
    text-align: left;
    font-weight: 600;
    border-bottom: 2px solid var(--border);
    white-space: nowrap;
}

.notion-database td {
    padding: 12px 16px;
    border-bottom: 1px solid var(--border-light);
}

.notion-database tbody tr:hover {
    background: var(--bg-hover);
}

.notion-database tbody tr:last-child td {
    border-bottom: none;
}
</style>
{% endblock %}
